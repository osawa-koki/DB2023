<!doctype html><html lang=ja><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://osawa-koki.github.io/DB2023/Logo.png type=image/x-icon><link rel=stylesheet href=https://osawa-koki.github.io/DB2023/sass/style.min.dc0078058ce9074c96338ad888d8e91b59fba1e714614cf45118578944e151d7.css><link rel=stylesheet href=https://osawa-koki.github.io/DB2023/sass/single.min.4c7c51cf79fbade0103a0aa22d7901040321c00aed7870eb923bc9195b1f8a14.css><link rel=stylesheet href=https://osawa-koki.github.io/DB2023/sass/content.min.29f09606f5140407d848c87a91f73509241b381546612af92f28f53e2fd2de65.css><link rel=stylesheet href=https://osawa-koki.github.io/DB2023/bootstrap-5.0.2-dist/css/bootstrap.min.css><title>副問い合わせ | データベーススペシャリスト試験対策</title></head><body><header><a href=https://osawa-koki.github.io/DB2023/><img id=LogoImage src=https://osawa-koki.github.io/DB2023/Logo.png alt=Logo></a></header><main><div id=Single><div id=MainDiv><div id=content-header><div id=content-title>副問い合わせ</div><div id=content-description>SQLの最初の難関！？副問い合わせについてです。</div><div id=content-date>2022.12.25</div><div id=content-categories><div class=category>DB2023</div><div class=category>教科書</div></div><div id=content-tags><div class=tag>SQL</div></div></div><div id=MainBody><div id=content><h2 id=副問い合わせ>副問い合わせ</h2><p>副問合せとはSELECT文を入れ子にすることを言います。<br>サブクエリとも言います。<br>SELECT文で使用する条件にSELECT文の結果を使用する場合に使用します。</p><p>SELECT文の中で使用されるSELECT文を副問合せ文、ないしはサブクエリ文と呼びます。</p><p>また、副問合せ文は括弧で囲んで書きます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>カラム名</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>カラム</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> ...);
</span></span></code></pre></div><p>すっごく複雑です、、、<br>分からなくなったら紙に書いて整理しながら進めましょう♪</p><h2 id=副問合せの結果の型>副問合せの結果の型</h2><p>副問合せが返すデータの型には以下の3種類あります。</p><ul><li>スカラ型</li><li>一次元配列型(ベクタ型)</li><li>二次元配列型(マトリックス型)</li></ul><p><img src=../img/scalar-vector-matrix.png alt=スカラ型・ベクタ型・マトリックス型></p><p>※ <a href=https://www.mathsisfun.com/algebra/scalar-vector-matrix.html>MATH is FUN</a>より引用</p><h3 id=スカラ型>スカラ型</h3><p>単一の値を指します。<br>例えば以下のクエリが返す結果が該当します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>MAX</span>(HP) <span style=color:#66d9ef>FROM</span> status;
</span></span></code></pre></div><p><img src=../img/scalar.png alt=スカラ型></p><h3 id=一次元配列型ベクタ型>一次元配列型(ベクタ型)</h3><p>スカラ型データを複数集めたデータ型です。<br>例えば、以下のクエリが返す結果が該当します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> HP
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ほのお&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ひこう&#39;</span>;
</span></span></code></pre></div><p><img src=../img/vector.png alt=ベクタ型></p><hr><p><strong>あくまでも単一の列で複数の行のデータであることに注意してください。</strong><br>単一の行で列が複数の場合はsqlでは一次元配列型とは認識されません。<br>例えば以下のクエリの結果は一次元配列型には該当しません。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>AVG</span>(HP), <span style=color:#66d9ef>AVG</span>(<span style=color:#960050;background-color:#1e0010>防御</span>), <span style=color:#66d9ef>AVG</span>(<span style=color:#960050;background-color:#1e0010>特防</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> status
</span></span></code></pre></div><p><img src=../img/non-vector.png alt=非ベクタ型></p><p>単一の行で列が複数の場合は次に説明する二次元配列型と認識されます。</p><h3 id=二次元配列型マトリックス型>二次元配列型(マトリックス型)</h3><p>複数行×複数列からなるデータ型です。<br>例えば、以下のクエリが返す結果が該当します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>図鑑番号</span>, <span style=color:#960050;background-color:#1e0010>名前</span>, HP
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ほのお&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ひこう&#39;</span>;
</span></span></code></pre></div><p><img src=../img/matrix.png alt=マトリックス型></p><hr><p>ちなみに、もう一つ上の次元にtensorというものがあります。</p><p><img src=../img/scalar-vector-matrix-tensor.png alt=tensor></p><p>※ <a href=https://hadrienj.github.io/posts/Deep-Learning-Book-Series-2.1-Scalars-Vectors-Matrices-and-Tensors/>hadrienjさんの記事</a>より</p><h2 id=副問合せを使用したsql>副問合せを使用したSQL</h2><p>では、実際に副問い合わせを使用したSQLを実行してみましょう♪</p><h3 id=スカラ型を使用した副問い合わせ>スカラ型を使用した副問い合わせ</h3><p>では、最初にHPの種族値が最大のポケモンと最低のポケモンの全てのデータを表示してみましょう♪</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> HP <span style=color:#f92672>=</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>MAX</span>(HP) <span style=color:#66d9ef>FROM</span> status);
</span></span></code></pre></div><p><img src=../img/subquery-scalar.png alt=サブクエリ-スカラ型></p><h3 id=ベクタ型を使用した副問い合わせ>ベクタ型を使用した副問い合わせ</h3><p>先ほどは副問合せの結果は単一の値でしたが、今度は副問合せの結果が複数の値を返す場合の処理を行いましょう♪</p><p>式と関数の授業で説明したIN/ANY/ALL関数を使用します。<br>では、全てのほのおタイプのHP種族よりもHP種族値が高いみずタイプのポケモンを取得しましょう♪<br>ほのおタイプのポケモンのHP種族値の最大を求めて、これを条件に使用することもできます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>図鑑番号</span>, <span style=color:#960050;background-color:#1e0010>名前</span>, HP
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;みず&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> HP <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ALL</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> HP
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ほのお&#39;</span>
</span></span><span style=display:flex><span>  );
</span></span></code></pre></div><p><img src=../img/subquery-vector.png alt=サブクエリ-ベクタ型></p><h3 id=マトリックス型を使用した副問い合わせ>マトリックス型を使用した副問い合わせ</h3><p>主にFROMの対象として使用します。<br>では先ほどの全てのほのおタイプのHP種族よりもHP種族値が高いみずタイプのポケモンの検索結果から名前が5文字のポケモンを取得しましょう♪</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>図鑑番号</span>, <span style=color:#960050;background-color:#1e0010>名前</span>, HP
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>図鑑番号</span>, <span style=color:#960050;background-color:#1e0010>名前</span>, HP
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;みず&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>AND</span> HP <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ALL</span> (
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>SELECT</span> HP
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> status
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>タイプ</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ほのお&#39;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  ) <span style=color:#66d9ef>AS</span> <span style=color:#960050;background-color:#1e0010>ダミー</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>名前</span> <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;_____&#39;</span>;
</span></span></code></pre></div><p>FROMの対象にサブクエリの結果を使用する場合にはASを用いて別名を付ける必要があります。<br>上の例ではダミーという名前を付けています。</p><p><img src=../img/subquery-matrix.png alt=サブクエリ-マトリックス型></p><h2 id=相関副問い合わせ>相関副問い合わせ</h2><blockquote><p>「相関副問合せ」とは、主問合せで処理したい行によって副問合せの条件を変えながら検索することができる構文です。<br><a href=https://atmarkit.itmedia.co.jp/ait/articles/1209/14/news146.html>itmedia</a>より引用。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#960050;background-color:#1e0010>列</span><span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>列</span><span style=color:#ae81ff>2</span>, <span style=color:#960050;background-color:#1e0010>列</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>テーブル</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>EXISTS</span> (
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>FROM</span> <span style=color:#960050;background-color:#1e0010>テーブル</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>WHERE</span> <span style=color:#960050;background-color:#1e0010>テーブル</span><span style=color:#ae81ff>1</span>.<span style=color:#960050;background-color:#1e0010>列</span>X <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>テーブル</span><span style=color:#ae81ff>2</span>.<span style=color:#960050;background-color:#1e0010>列</span>Y
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>EXISTS句やNOT EXISTS句とともに使用し、存在確認のために使用されることが多いです。<br>副問い合わせ際に主問い合わせの結果を使用するため、「1. 副問い合わせ」「2. 主問い合わせ」の順ではなく、1行ずつ順に処理していきます。</p><p>また、副問い合わせでの抽出対象カラムはなんでも問題ありませんが、ここでは特定のカラムを指定することを避けるため「*」としています。</p></div></div></div><div id=SubDiv><div id=Menu><div class=title>教科書</div><a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%9b%e3%83%bc%e3%83%a0>ホーム</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%87%e3%83%bc%e3%82%bf%e3%83%99%e3%83%bc%e3%82%b9%e5%9f%ba%e7%a4%8e>データベース基礎</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/sql%e3%81%ae%e7%a8%ae%e9%a1%9e>SQLの種類</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%87%e3%83%bc%e3%82%bf%e6%93%8d%e4%bd%9c%e8%a8%80%e8%aa%9e>データ操作言語</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%86%e3%83%bc%e3%83%96%e3%83%ab%e3%81%ae%e7%b5%90%e5%90%88>テーブルの結合</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e9%9b%86%e5%90%88%e6%bc%94%e7%ae%97>集合演算</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e5%89%af%e5%95%8f%e3%81%84%e5%90%88%e3%82%8f%e3%81%9b class=active>副問い合わせ</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%87%e3%83%bc%e3%82%bf%e5%ae%9a%e7%be%a9%e8%a8%80%e8%aa%9e>データ定義言語</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%87%e3%83%bc%e3%82%bf%e5%88%b6%e5%be%a1%e8%a8%80%e8%aa%9e>データ制御言語</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e5%9f%8b%e8%be%bc%e3%81%bf%e5%9e%8bsql>埋込み型SQL</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%aa%e3%83%ac%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%8a%e3%83%ab%e3%83%a2%e3%83%87%e3%83%ab>リレーショナルモデル</a>
<a href=https://osawa-koki.github.io/DB2023/textbook/%e6%a6%82%e5%bf%b5%e3%83%87%e3%83%bc%e3%82%bf%e3%83%a2%e3%83%87%e3%83%ab>概念データモデル</a><div class=title>カラム</div><a href=https://osawa-koki.github.io/DB2023/column/%e5%87%ba%e9%a1%8c%e5%82%be%e5%90%91/>出題傾向</a>
<a href=https://osawa-koki.github.io/DB2023/column/db%e8%a9%a6%e9%a8%93-%e6%88%a6%e7%95%a5%e7%9a%84%e5%ad%a6%e7%bf%92%e3%81%ae%e3%82%b9%e3%82%b9%e3%83%a1/>DB試験-戦略的学習のススメ</a>
<a href=https://osawa-koki.github.io/DB2023/column/sql%e3%81%a8%e3%83%aa%e3%83%ac%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%8a%e3%83%ab%e3%83%a2%e3%83%87%e3%83%ab/>SQLとリレーショナルモデル</a></div></div></div><div><div id=ButtonContainer><a class="btn btn-success" href=https://osawa-koki.github.io/DB2023/textbook/%e9%9b%86%e5%90%88%e6%bc%94%e7%ae%97 id=PrevButton>前へ</a>
<a class="btn btn-primary" href=https://osawa-koki.github.io/DB2023/textbook/%e3%83%87%e3%83%bc%e3%82%bf%e5%ae%9a%e7%be%a9%e8%a8%80%e8%aa%9e id=NextButton>次へ</a></div></div></main><footer></footer></body></html>