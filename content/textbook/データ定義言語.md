---
title: "データ定義言語"
date: 2022-12-25T21:39:06+09:00
draft: false
description: "自分でイチから作らないと使う機会が少ない、データ定義言語についてです。"
categories: ["DB2023", "教科書"]
tags: ["SQL", "論理設計"]
---

## データ定義言語

「Data Definition Language」の略です。  

データベース・テーブル・ビューに関する定義や、それらに関する権限の設定を行うためのSQLです。  
以下のメソッドが該当します。  

| メソッド | 説明 |
| ---- | ---- |
| CREATE | データベース・テーブル・ビューを定義する。 |
| ALTER | データベース・テーブル・ビューの定義を変更する。 |
| DROP | データベース・テーブル・ビューを削除する。 |

## CREATE文

テーブル・ビューなどの資源を新規作成する際に使用されるSQLです。  
具体的にはCREATE文では以下の資源を作成することができます。  

- DATABASE (データベース)
- TABLE (テーブル)
- VIEW (ビュー)
- ROLE (ロール)
- TRIGGER (トリガー)

### CREATE TABLE

テーブルを新規に作成します。  

```sql
CREATE TABLE テーブル名 (
  列名1 データ型 [列制約定義],
  列名2 データ型 [列制約定義],
  列名3 データ型 [列制約定義],
  [テーブル制約定義]
);
```

#### データ型

データベースで使用可能なデータ型はRDBMSによって異なりますが、基本的には以下の5つからなります。  

- 整数型 (INTEGER/SMALLINT)
- 小数型 (FLOAT/DECIMAL)
- 文字列型 (CHAR/VARCHAR/NCHAR/NVARCHAR)
- 日付型 (DATE/DATETIME/TIME)
- バイト型 (BLOB)

また、文字列型に関しては固定バイト数文字列型(CHAR)と可変バイト数文字列型(VARCHAR)に分けられ、また格納対象となる文字によって半角(CHAR/VARCHAR)と全角(NCHAR/NVARCHAR)に分類されます。  

#### 制約

列またはテーブル全体に対して格納する値に関して制約を課すことができます。  
以下の制約が使用可能です。  

| 制約名 | キーワード | 説明 |
| ---- | ---- | ---- |
| 非ナル制約 | NOT NULL | NULLの代入を禁止する制約。 |
| デフォルト値 | DEFAULT | 値が代入されない場合に既定で代入される値の設定。 |
| 一意性制約 | UNIQUE | 指定した列、または列の組み合わせが当該テーブルで一意であることを約束する制約。 |
| 主キー制約 | PRIMARY KEY | 非ナル制約 + 一意性制約 ( + インデックス) |
| 検査制約 | CHECK | 代入される値に対して条件を設定。 |
| 参照制約 | FOREIGN KEY | 外部テーブルを参照している場合に、2つのデーブル間での整合性を保つための制約。 |

```sql
CREATE TABLE pokemon(
  number INTEGER PRIMARY KEY,
  name NVARCHAR(5) UNIQUE,
  type1 NVARCHAR(5) NOT NULL,
  type2 NVARCHAR(5),
  is_valid INTEGER DEFAULT 1,
  hp INTEGER NOT NULL CHECK(0 < hp),
  ...
);
```

また、制約にはCONSTRAINTキーワードを使用して任意の名前を付けることができます。  
これは後から修正する場合に役立ちます。  

##### 参照制約

外部テーブルを参照している場合に、2つのデーブル間での整合性を保つための制約で、**参照元テーブルに外部キーを設定し、参照制約を課す**ことでテーブル間の整合性を保証します。  

参照先でのデータの変更に際しては以下の処理が設定可能です。  

| オプション | 説明 |
| ---- | ---- |
| NO ACTION | 参照元にデータが存在している場合に、参照先のデータの変更(更新・削除)を拒否。  (デフォルト) |
| CASCADE | 参照元にデータが存在している場合に、参照先のデータの変更(更新・削除)した場合に、参照元のデータも連携して削除。 |
| SET NULL | 参照元にデータが存在している場合に、参照先のデータの変更(更新・削除)した場合に、参照元のデータにNULLをセット。 |

例えば、pokemonテーブルでポケモン図鑑を、my_pokemonテーブルで自分がゲットしたポケモンを管理するとします。  

```sql
CREATE TABLE my_pokemon(
  id INTEGER PRIMARY KEY,
  number INTEGER NOT NULL CHECK(0 < number AND number <= 1008),
  nickname NVARCHAR(5) NOT NULL,
  FOREIGN KEY(number)
  REFERENCES pokemon(number)
  ON UPDATE SET NULL,
  ON DELETE CASCADE,
);
```

ポケモン図鑑で削除された場合、自分がそのポケモンを仲間にしているのはダメですよね、、、  
実際にはポケモン図鑑から削除されることはありませんが、、、  

万が一、ポケモン図鑑のポケモンが変更(更新・削除)された場合には、それに応じて自分がゲットしたポケモンのデータも修正する必要があります。  
上の例では、ポケモン図鑑が更新された場合には、対象となるポケモンの値をNULLにセットし、ポケモン図鑑からポケモンが削除された場合には自分のデータからも削除しています。  

##### 表明

テーブルをまたぐような複雑な制約を課すことができます。  
アサーション(ASSERTION)と呼びます。  

例えば、`テーブルAとテーブルBのカラムXの最大値はテーブルCのカラムYの最大値よりも小さい`などといったものです。  
このような複雑な制約はアサーションで定義できます。  

```sql
CREATE ASSERTION アサーション名
CHECK NOT EXISTS(
  SELECT *
  ...
);
```

使用する機会はあまりありませんが、出題されたことがある内容ですので、一応、、、  

##### 定義域

ドメインとも呼びます。  
自分自身で定義するデータ型と説明されることもあります。  

例えば、郵便番号は文字列として格納されますが、「xxx-xxxx」の形式を満たす必要があります。  
このような場合に、定義域を使用することで「xxx-xxxx」の形式を満たさないデータを排除することができます。  

定義域は以下のように定義します。  

```sql
CREATE DOMAIN 定義域名
AS データ型
CHECK(...);
```

例えば、郵便番号用の定義域は以下のように定義することができます。  

```sql
CREATE DOMAIN postal_code
AS CHAR(8)
CHECK(postal_code LIKE '___-____');
```

### CREATE VIEW

ビューとは仮想的なテーブルのことをいい、SELECT結果を疑似的にテーブルとして扱うことができようにしたものです。  
ビューを使用する利点として以下のものがあります。  

- テーブル間の整合性の保証が容易
- セキュリティ上の観点から、アクセス権限を設定可能

ビューは以下のように定義します。  

```sql
CREATE VIEW ビュー名
AS SELECT カラム1, カラム2, ...
FROM ...;
```

また、`WITH CHECK OPTION`を付けることで、SELECT文の後に指定した条件と合致しないデータが挿入されようとした場合に、その挿入を拒否することができます。  

#### 更新可能なビュー

更新可能なビューとはその名の通り、更新ができるビューのことを言います。  
逆に更新ができないビューとは、集約関数やDISTINCT句を使用しているため、元の行が特定できないため、更新できないものを言います。  
また、GROUP BY句を使用している場合や、元のテーブルが特定できない場合にも更新できません。  

#### ビューと権限

ビューを作成する場合には対象となる元のテーブル全てに関してSELECT権限が必要です。  
また、GRANT OPTIONがある場合には、その役割通り、作成したビューの権限を他に付与することができます。  

### CREATE ROLE

権限グループである、ロールを作成することができます。  

```sql
CREATE ROLE ロール名;
```

ロールの使用には以下の手順を踏みます。  

1. ロールの作成
2. ロールに権限を付与
3. ユーザにロールを付与

ここでは「1. ロールの作成」について説明しました。  
それ以外については後ほど説明しますが、ここでも簡単に紹介します。  

```sql
-- 2. ロールに権限を付与
GRANT 権限 ON 対象 TO ロール;

-- 3. ユーザにロールを付与
GRANT ロール TO ユーザ;
```

## DROP文

定義した内容を削除する際に使用します。  

```sql
DROP DATABASE データベース名;
DROP TABLE テーブル名;
DROP VIEW ビュー名;
DROP ROLE ロール名;
```

## ALTER文

定義した内容を修正します。  
一般的にはパフォーマンスの観点から、さらにはデータ整合性の観点からスキーマを後から変更するという処理は推奨されません。  

### リネーム

テーブル名やカラム名を変更します。  

```sql
-- テーブル名の変更
ALTER TABLE 変更前
RENAME TO 変更後;

-- カラム名の変更
ALTER TABLE テーブル名
RENAME COLUMN 変更前 TO 変更後;
```

### 定義の変更

カラム定義を変更するには以下のSQLを実行します。  

```sql
ALTER TABLE テーブル名
MODIFY COLUMN カラム名 データ型 [列制約];
```

また、カラム名の変更と定義の変更を同時に行うこともできます。  

```sql
ALTER TABLE テーブル名
CHANGE COLUMN 変更前カラム名 変更後カラム名 データ型 [列制約];
```

### カラムの追加

```sql
ALTER TABLE テーブル名
ADD COLUMN カラム名 データ型 [列制約];
```

原則として最後に追加されますが、`FIRST`や`AFTER カラム名`とすることで任意の位置に追加することができます。  
もっとも、カラムは単なるリレーションであって、順番が影響するような設計は間違っていますが、きれい好きな方は使用したいかもしれません。  

### カラムの削除

```sql
ALTER TABLE テーブル名
DROP COLUMN カラム名;
```
